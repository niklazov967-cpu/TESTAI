<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки - Поиск аналогов сталей</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .settings-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .settings-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .settings-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.9em;
        }
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .code-block {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .required-section {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .required-section h3 {
            margin-top: 0;
            color: #856404;
        }
        .info-box {
            margin-top: 20px;
            padding: 15px;
            border-left: 4px solid #667eea;
            border-radius: 5px;
            font-size: 0.95em;
            line-height: 1.8;
        }
        .info-box.blue {
            background: #f0f8ff;
            border-color: #667eea;
        }
        .info-box.yellow {
            background: #fff3cd;
            border-color: #ffc107;
        }
        .info-box.green {
            background: #d4edda;
            border-color: #28a745;
        }
        .info-box strong {
            display: block;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>⚙️ Настройки системы</h1>
            <p class="subtitle">Конфигурация и документация</p>
        </header>

        <main class="settings-container">
            <a href="index.html" class="back-link">← Вернуться к поиску сталей</a>
            <div style="margin-bottom: 10px;">
                <a href="home.html" class="back-link" style="margin-right: 15px;">🏠 Главная</a>
                <a href="stats.html" class="back-link">📊 Статистика</a>
            </div>

            <div id="alert-container"></div>

            <!-- Обязательный просмотр промптов и алгоритмов -->
            <div class="required-section">
                <h3>📚 ОБЯЗАТЕЛЬНО К ПРОСМОТРУ</h3>
                <p>Перед использованием системы обязательно ознакомьтесь с промптами и алгоритмами работы в разделе "Документация" ниже.</p>
            </div>

            <!-- Пресеты -->
            <div class="settings-section">
                <h2>🎛️ Пресеты конфигурации</h2>
                <p>Быстрый выбор оптимальных настроек для разных сценариев использования</p>
                <div class="preset-buttons">
                    <button class="preset-btn" data-preset="quick">⚡ Быстрый поиск</button>
                    <button class="preset-btn active" data-preset="balanced">⚖️ Сбалансированный</button>
                    <button class="preset-btn" data-preset="precise">🎯 Точный анализ</button>
                </div>
            </div>

            <!-- Параметры поиска (Stage 1) -->
            <div class="settings-section">
                <h2>🔎 Параметры поиска (Stage 1: Tavily)</h2>
                <p>Настройки для первого этапа — поиска данных о сталях через Tavily API</p>
                
                <div class="form-group">
                    <label for="tavily_max_results">Результатов на запрос:</label>
                    <input type="number" id="tavily_max_results" min="1" max="20" value="5">
                    <small>От 1 до 20. Количество результатов на один поисковый запрос. Система выполняет 9 запросов.</small>
                </div>

                <div class="form-group">
                    <label for="max_iterations">Максимум итераций обработки:</label>
                    <input type="number" id="max_iterations" min="1" max="10" value="3">
                    <small>От 1 до 10. Количество попыток обработки данных при неудаче на Stage 2.</small>
                </div>

                <div class="info-box blue">
                    <strong>Автоматические действия Stage 1:</strong>
                    • Генерация 9 специализированных поисковых запросов<br>
                    • Параллельное выполнение запросов к Tavily<br>
                    • Агрегация и удаление дубликатов<br>
                    • Сортировка по релевантности
                </div>
            </div>

            <!-- Параметры обработки (Stage 2) -->
            <div class="settings-section">
                <h2>🤖 Параметры обработки (Stage 2: DeepSeek)</h2>
                <p>Настройки для второго этапа — обработки данных и поиска аналогов через DeepSeek AI</p>
                
                <div class="form-group">
                    <label for="deepseek_temperature">Температура модели:</label>
                    <input type="number" id="deepseek_temperature" min="0" max="1" step="0.1" value="0.7">
                    <small>От 0.0 до 1.0. Чем выше значение, тем более креативные и разнообразные ответы.</small>
                </div>

                <div class="info-box green">
                    <strong>Автоматические расчёты Stage 2:</strong>
                    • Парсинг и структурирование данных о сталях<br>
                    • Расчет углеродного эквивалента (CE) для каждого аналога<br>
                    • Автоматическая классификация стали (углеродистая, легированная, нержавеющая и т.д.)<br>
                    • Оценка свариваемости на основе CE и типа стали<br>
                    • Оценка популярности марки стали
                </div>
            </div>

            <!-- Параметры валидации (Stage 3) -->
            <div class="settings-section">
                <h2>✅ Параметры валидации (Stage 3: OpenAI)</h2>
                <p>Настройки для третьего этапа — валидации и фактчекинга через OpenAI</p>
                
                <div class="form-group">
                    <label for="validation_strictness">Строгость валидации:</label>
                    <select id="validation_strictness">
                        <option value="low">Низкая (принимает больше результатов)</option>
                        <option value="medium">Средняя (рекомендуется)</option>
                        <option value="high">Высокая (строгая проверка)</option>
                        <option value="strict">Очень строгая (максимальная точность)</option>
                    </select>
                    <small>Уровень строгости фактчекинга и валидации результатов от DeepSeek</small>
                </div>

                <div class="form-group">
                    <label for="openai_model">Модель OpenAI:</label>
                    <select id="openai_model">
                        <option value="gpt-4o-mini">gpt-4o-mini (быстро, экономично)</option>
                        <option value="gpt-4o">gpt-4o (баланс скорости и качества)</option>
                        <option value="gpt-4-turbo">gpt-4-turbo (максимальное качество)</option>
                    </select>
                    <small>Модель для валидации. Более мощные модели = выше точность и стоимость</small>
                </div>

                <div class="form-group">
                    <label for="openai_temperature">Температура модели:</label>
                    <input type="number" id="openai_temperature" min="0" max="1" step="0.1" value="0.3">
                    <small>От 0.0 до 1.0. Низкая температура = более консервативные и точные оценки</small>
                </div>

                <div class="info-box yellow">
                    <strong>Критерии валидации OpenAI:</strong>
                    • Механические свойства (30% веса)<br>
                    • Химический состав (25% веса)<br>
                    • Углеродный эквивалент (20% веса)<br>
                    • Класс стали (15% веса)<br>
                    • Свариваемость (5% веса)<br>
                    • Популярность марки (3% веса)<br>
                    • Вредные примеси (2% веса)<br>
                    <br>
                    <em>Общая оценка от 0 до 100. Результаты с низкой оценкой отклоняются.</em>
                </div>
            </div>

            <!-- Общие настройки -->
            <div class="settings-section">
                <h2>⚙️ Общие настройки</h2>
                <form id="config-form">
                    <div class="form-group">
                        <label for="cache_enabled">Кэширование результатов:</label>
                        <select id="cache_enabled">
                            <option value="true">Включено (рекомендуется)</option>
                            <option value="false">Выключено</option>
                        </select>
                        <small>Сохранять результаты для мгновенного доступа при повторных запросах той же стали</small>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">💾 Сохранить настройки</button>
                        <button type="button" class="btn btn-secondary" id="reset-config">🔄 Сбросить к умолчаниям</button>
                    </div>
                </form>
            </div>

            <!-- Управление кэшем -->
            <div class="settings-section">
                <h2>💾 Администрирование кэша</h2>
                <p>Кэш хранит результаты предыдущих поисков для ускорения повторных запросов.</p>
                
                <div id="cache-info" style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                    <strong>Всего записей:</strong> <span id="cache-count">0</span> | 
                    <strong>Размер:</strong> <span id="cache-size">0 MB</span>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <input type="text" id="cache-search" placeholder="🔍 Поиск по названию стали..." 
                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                </div>
                
                <div id="cache-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    <p style="text-align: center; color: #666;">Загрузка...</p>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-danger" id="clear-cache-btn">🗑️ Очистить весь кэш</button>
                    <button class="btn btn-secondary" id="refresh-cache-btn">🔄 Обновить список</button>
                </div>
            </div>

            <!-- Документация -->
            <div class="settings-section">
                <h2>📚 Документация системы</h2>
                
                <div class="tabs">
                    <button class="tab active" data-tab="prompts">Промпты</button>
                    <button class="tab" data-tab="algorithms">Алгоритмы</button>
                    <button class="tab" data-tab="architecture">Архитектура</button>
                </div>

                <div id="prompts" class="tab-content active">
                    <h3>Промпты для трёхэтапной обработки</h3>
                    <div id="prompts-content" class="code-block">
                        <p>Загрузка промптов...</p>
                    </div>
                </div>

                <div id="algorithms" class="tab-content">
                    <h3>Алгоритмы работы системы</h3>
                    <div id="algorithms-content" class="code-block">
                        <h4>Stage 1: Tavily Search (Поиск данных)</h4>
                        <pre>1. Генерация 9 поисковых запросов для заданной марки стали
2. Выполнение параллельных запросов через Tavily API
3. Агрегация результатов и удаление дубликатов
4. Сортировка по релевантности
5. Возврат топ-10 источников для обработки</pre>

                        <h4>Stage 2: DeepSeek Processing (Обработка)</h4>
                        <pre>1. Построение промпта с данными из Stage 1
2. Отправка запроса в DeepSeek API
3. Парсинг JSON ответа с аналогами
4. Проверка наличия титана (Ti) в составе
5. Если Ti отсутствует - повторная попытка (до 3 раз)
6. Расчет углеродного эквивалента (CE)
7. Классификация стали
8. Оценка популярности и свариваемости</pre>

                        <h4>Stage 3: OpenAI Validation (Валидация)</h4>
                        <pre>1. Проверка наличия Ti во всех аналогах
2. Построение промпта валидации
3. Отправка запроса в OpenAI API
4. Фактчекинг всех параметров:
   - Механические свойства (30%)
   - Химический состав (25%)
   - Углеродный эквивалент (20%)
   - Класс стали (15%)
   - Свариваемость (5%)
   - Популярность (3%)
   - Вредные примеси (2%)
5. Расчет общей оценки (0-100)
6. Генерация ошибок, предупреждений и рекомендаций</pre>

                        <h4>Расчет углеродного эквивалента (CE)</h4>
                        <pre>CE = C + (Mn/6) + (Ni/20) + (Cr/10) + (Mo/50) + (V/10)

Оценка свариваемости:
- CE ≤ 0.35: отличная
- CE 0.36-0.45: хорошая
- CE 0.46-0.55: требуется подогрев
- CE > 0.55: сложная</pre>
                    </div>
                </div>

                <div id="architecture" class="tab-content">
                    <h3>Архитектура системы</h3>
                    <div id="architecture-content" class="code-block">
                        <pre>┌─────────────────────────────────────────────────────────┐
│                    FRONTEND (Browser)                    │
│  index.html → script.js → API calls                     │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP/JSON
                     ▼
┌─────────────────────────────────────────────────────────┐
│              BACKEND (Node.js + Express)                │
│                                                         │
│  ┌──────────────────────────────────────────────┐      │
│  │         server.js (API Routes)               │      │
│  └──────────────┬───────────────────────────────┘      │
│                 │                                       │
│  ┌──────────────▼───────────────────────────────┐      │
│  │      searchEngine.js (Main Pipeline)         │      │
│  │                                              │      │
│  │  STAGE 1: Tavily Search                     │      │
│  │  ├─ tavilyClient.js                         │      │
│  │  └─ stage1_search.js                        │      │
│  │                                              │      │
│  │  STAGE 2: DeepSeek Processing               │      │
│  │  ├─ deepseekClient.js                       │      │
│  │  ├─ promptBuilder.js                        │      │
│  │  ├─ utils.js                                │      │
│  │  └─ stage2_process.js                       │      │
│  │                                              │      │
│  │  STAGE 3: OpenAI Validation                 │      │
│  │  ├─ openaiClient.js                         │      │
│  │  └─ stage3_validate.js                      │      │
│  └──────────────────────────────────────────────┘      │
│                                                         │
│  ┌──────────────┐  ┌──────────────┐                   │
│  │ config.js    │  │cacheManager  │                   │
│  └──────────────┘  └──────────────┘                   │
└─────────────────────────────────────────────────────────┘
                     │
                     │ API Calls
                     ▼
┌─────────────────────────────────────────────────────────┐
│              EXTERNAL SERVICES                           │
│  Tavily API  │  DeepSeek API  │  OpenAI API            │
└─────────────────────────────────────────────────────────┘</pre>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="settings.js"></script>
</body>
</html>

